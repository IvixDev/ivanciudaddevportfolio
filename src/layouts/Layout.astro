---
import HeaderDock from "../components/HeaderDock";
import Footer from "../components/Footer";
import { SEO } from "astro-seo";
import { ClientRouter } from "astro:transitions";
import SpeedInsights from "@vercel/speed-insights/astro";
import type { InfoSeoProps } from "../types/types";

interface Props {
  infoSeo: InfoSeoProps;
}

const { infoSeo } = Astro.props;
const path = Astro.url.pathname;
import "../styles/global.css";
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <meta
      name="google-site-verification"
      content="rtqz__fHq7l_eMEEl-ULln50aHX17BLq7dSVgfVkLdU"
    />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <ClientRouter />

    <!-- SOLUCIÓN DEFINITIVA ANTI-FOAC/FOUC -->
    <style is:inline>
      /* 1. Fondo crítico inmediato: Evita el frame blanco */
      :root {
        background-color: #0f172a !important;
        color-scheme: dark;
      }

      /* 2. Bloqueo de transiciones durante la carga/navegación */
      /* Evita que los nodos "animen" desde un estado sin estilo al inyectarse */
      .no-transitions *,
      .no-transitions *::before,
      .no-transitions *::after {
        transition: none !important;
        animation: none !important;
      }

      html {
        color: white;
        background-color: #0f172a;
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          sans-serif;
      }
    </style>

    <script is:inline>
      // 3. Script bloqueante para el tema y prevención de parpadeos
      function applyTheme() {
        if (
          localStorage.getItem("theme") === "dark" ||
          (!("theme" in localStorage) &&
            window.matchMedia("(prefers-color-scheme: dark)").matches)
        ) {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }
      }

      // Aplicar inmediatamente para evitar flash de tema
      applyTheme();

      // 4. Ciclo de vida de View Transitions
      document.addEventListener("astro:before-swap", () => {
        // Bloqueamos todas las transiciones CSS justo antes de cambiar el HTML
        document.documentElement.classList.add("no-transitions");
      });

      document.addEventListener("astro:after-swap", () => {
        // Re-aplicamos tema en el nuevo documento
        applyTheme();
      });

      document.addEventListener("astro:page-load", () => {
        // Reactivamos transiciones solo una vez que el navegador ha pintado el nuevo estado
        // El doble rAF es el estándar de oro para asegurar un frame de pintura
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            document.documentElement.classList.remove("no-transitions");
          });
        });
      });
    </script>

    <SEO {...infoSeo} />
    <SpeedInsights />
  </head>
  <body
    class="flex flex-col min-h-screen bg-[radial-gradient(ellipse_80%_80%_at_50%_-20%,rgba(120,119,198,0.3),rgba(255,255,255,0))] text-white selection:bg-cyan-500/30 selection:text-cyan-200"
  >
    <!-- <Header /> -->
    <HeaderDock client:idle transition:persist currentPath={path} />
    <div class="flex flex-col items-center w-full">
      <main
        class="flex
        justify-center
        max-w-screen-tablet
        px-4
        pt-32 pb-10
        tablet:px-8
        tablet:max-w-screen-laptop
        laptop:px-16
        desktop:max-w-screen-desktop
        bigDesktop:max-w-screen-bigDesktop
        w-full layout-container"
      >
        <slot />
      </main>
      <Footer />
    </div>
    <style is:global>
      :root {
        color-scheme: dark;
      }
      html {
        font-family: "Onest", system-ui, sans-serif;
      }
    </style>
  </body>
</html>
